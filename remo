#!/bin/bash
# remo - Remote development environment CLI
# Manages Incus containers and Hetzner VMs for development environments

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ENV_FILE="$SCRIPT_DIR/.env"
ANSIBLE_DIR="$SCRIPT_DIR/ansible"
VENV_DIR="$SCRIPT_DIR/.venv"

# Activate virtual environment if it exists
if [ -d "$VENV_DIR" ] && [ -f "$VENV_DIR/bin/activate" ]; then
    source "$VENV_DIR/bin/activate"
fi

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# =============================================================================
# UTILITY FUNCTIONS
# =============================================================================

print_error() {
    echo -e "${RED}Error:${NC} $1" >&2
}

print_success() {
    echo -e "${GREEN}$1${NC}"
}

print_info() {
    echo -e "${BLUE}$1${NC}"
}

print_warning() {
    echo -e "${YELLOW}$1${NC}"
}

load_env() {
    if [ -f "$ENV_FILE" ]; then
        while IFS='=' read -r key value; do
            [[ -z "$key" || "$key" =~ ^[[:space:]]*# ]] && continue
            if [[ "$key" =~ ^[A-Za-z_][A-Za-z0-9_]*$ ]]; then
                export "$key=$value"
            fi
        done < "$ENV_FILE"
    fi
}

run_playbook() {
    local playbook="$1"
    shift
    cd "$ANSIBLE_DIR"
    ansible-playbook "$playbook" "$@"
}

# =============================================================================
# HELP SYSTEM
# =============================================================================

show_main_help() {
    cat << 'EOF'
remo - Remote development environment CLI

USAGE:
    remo <command> [options]
    remo --help

COMMANDS:
    init        Initialize remo (install dependencies, create .env)
    incus       Manage Incus containers (local or remote host)
    hetzner     Manage Hetzner Cloud VMs

EXAMPLES:
    remo init
    remo incus create dev1
    remo incus create dev1 --domain int.example.com
    remo incus update dev1 --only zellij
    remo incus destroy dev1 --yes
    remo incus list
    remo incus bootstrap

    remo hetzner create
    remo hetzner destroy --yes

Run 'remo <command> --help' for command-specific options.
EOF
}

show_init_help() {
    cat << 'EOF'
remo init - Initialize remo environment

USAGE:
    remo init [options]

DESCRIPTION:
    Sets up remo by installing dependencies and creating configuration files.
    Run this once after cloning the repository.

    This command will:
    1. Create a Python virtual environment (.venv)
    2. Install Ansible and hcloud Python packages
    3. Install required Ansible collections
    4. Create .env from .env.example (if not exists)

OPTIONS:
    --force     Recreate venv even if it exists
    --help      Show this help message

EXAMPLES:
    remo init
    remo init --force
EOF
}

# =============================================================================
# INIT COMMAND
# =============================================================================

handle_init() {
    local force=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --force)
                force=true
                shift
                ;;
            --help|-h)
                show_init_help
                return 0
                ;;
            -*)
                print_error "Unknown option: $1"
                echo "Run 'remo init --help' for usage."
                exit 1
                ;;
            *)
                print_error "Unexpected argument: $1"
                exit 1
                ;;
        esac
    done

    echo ""
    print_info "Initializing remo..."
    echo ""

    # Step 1: Create virtual environment
    if [ -d "$VENV_DIR" ] && [ "$force" = false ]; then
        print_success "✓ Virtual environment already exists (.venv)"
    else
        if [ "$force" = true ] && [ -d "$VENV_DIR" ]; then
            print_info "Removing existing virtual environment..."
            rm -rf "$VENV_DIR"
        fi
        print_info "Creating virtual environment..."
        python3 -m venv "$VENV_DIR"
        print_success "✓ Created virtual environment (.venv)"
    fi

    # Use venv binaries directly
    local python="$VENV_DIR/bin/python"
    local ansible_galaxy="$VENV_DIR/bin/ansible-galaxy"

    # Step 2: Install Python packages
    # Use uv if available (faster), otherwise use pip
    print_info "Installing Python packages (ansible, hcloud)..."
    if command -v uv &> /dev/null; then
        uv pip install --quiet --python "$python" ansible hcloud
    else
        # Ensure pip is available
        "$python" -m ensurepip --quiet 2>/dev/null || true
        "$python" -m pip install --quiet --upgrade pip
        "$python" -m pip install --quiet ansible hcloud
    fi
    print_success "✓ Installed ansible and hcloud"

    # Step 3: Install Ansible collections
    print_info "Installing Ansible collections..."
    "$ansible_galaxy" collection install -r "$ANSIBLE_DIR/requirements.yml" > /dev/null
    print_success "✓ Installed Ansible collections"

    # Step 4: Create .env file
    local env_example="$SCRIPT_DIR/.env.example"
    if [ -f "$ENV_FILE" ]; then
        print_success "✓ Configuration file already exists (.env)"
    elif [ -f "$env_example" ]; then
        cp "$env_example" "$ENV_FILE"
        print_success "✓ Created configuration file (.env)"
    else
        print_warning "⚠ No .env.example found, skipping .env creation"
    fi

    # Print next steps
    echo ""
    print_success "═══════════════════════════════════════════════════════════════"
    print_success "  remo initialized successfully!"
    print_success "═══════════════════════════════════════════════════════════════"
    echo ""

    if [ -f "$ENV_FILE" ]; then
        echo "Next step: Configure your credentials in .env"
        echo ""
        echo -e "  ${YELLOW}For Hetzner Cloud:${NC}"
        echo "    HETZNER_API_TOKEN  - Get from https://console.hetzner.cloud/"
        echo "    DUCKDNS_TOKEN      - Get from https://www.duckdns.org/"
        echo "    DUCKDNS_DOMAIN     - Your subdomain (without .duckdns.org)"
        echo ""
        echo -e "  ${YELLOW}For Incus (local/homelab):${NC}"
        echo "    No credentials needed - uses SSH keys"
        echo ""
        echo "Then run:"
        echo -e "  ${GREEN}./remo incus create dev1 --host <incus-host> --user <user>${NC}"
        echo -e "  ${GREEN}./remo hetzner create${NC}"
        echo ""
    fi
}

show_incus_help() {
    cat << 'EOF'
remo incus - Manage Incus containers

USAGE:
    remo incus <command> [options]

COMMANDS:
    create <name>       Create and configure a new container
    destroy <name>      Destroy an existing container
    update <name>       Update dev tools on an existing container
    list                List all containers
    bootstrap           Initialize Incus host (network, storage)

CREATE OPTIONS:
    --domain <domain>   Set container domain (e.g., int.example.com)
    --image <image>     Container image (default: images:ubuntu/24.04/cloud)
    --host <host>       Remote Incus host (default: localhost)
    --user <user>       SSH user for remote host

DESTROY OPTIONS:
    --yes, -y           Skip confirmation prompt
    --host <host>       Remote Incus host (default: localhost)
    --user <user>       SSH user for remote host

UPDATE OPTIONS:
    --only <tool>       Only update specified tool (can repeat)
    --skip <tool>       Skip specified tool (can repeat)
    --host <host>       Remote Incus host (default: localhost)
    --user <user>       SSH user for remote host

    Available tools: docker, user_setup, nodejs, devcontainers, github_cli, fzf, zellij

BOOTSTRAP OPTIONS:
    --host <host>       Remote Incus host (default: localhost)
    --user <user>       SSH user for remote host
    -v, --verbose       Show detailed output

EXAMPLES:
    remo incus create dev1
    remo incus create dev1 --domain int.get2know.io
    remo incus create dev1 --host 192.168.1.100 --user admin
    remo incus destroy dev1 --yes
    remo incus update dev1 --only zellij
    remo incus update dev1 --skip docker --skip nodejs
    remo incus list
    remo incus bootstrap --host myserver.local --user root
EOF
}

show_hetzner_help() {
    cat << 'EOF'
remo hetzner - Manage Hetzner Cloud VMs

USAGE:
    remo hetzner <command> [options]

COMMANDS:
    create              Provision a new Hetzner VM
    destroy             Tear down a Hetzner VM

CREATE OPTIONS:
    --name <name>       Server name (default: remote-coding-server)
    --type <type>       Server type (default: cx22)
    --location <loc>    Datacenter location (default: hel1)

DESTROY OPTIONS:
    --yes, -y           Skip confirmation prompt
    --remove-volume     Also remove the persistent volume (DESTROYS DATA!)

NOTES:
    Requires HETZNER_API_TOKEN in .env file or environment.
    The persistent volume is preserved by default on destroy.

EXAMPLES:
    remo hetzner create
    remo hetzner create --name my-server --type cx32
    remo hetzner destroy --yes
    remo hetzner destroy --yes --remove-volume
EOF
}

# =============================================================================
# INCUS COMMANDS
# =============================================================================

incus_create() {
    local name=""
    local domain=""
    local image=""
    local host="localhost"
    local user=""
    local extra_args=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --domain)
                domain="$2"
                shift 2
                ;;
            --image)
                image="$2"
                shift 2
                ;;
            --host)
                host="$2"
                shift 2
                ;;
            --user)
                user="$2"
                shift 2
                ;;
            -*)
                print_error "Unknown option: $1"
                echo "Run 'remo incus --help' for usage."
                exit 1
                ;;
            *)
                if [ -z "$name" ]; then
                    name="$1"
                else
                    print_error "Unexpected argument: $1"
                    exit 1
                fi
                shift
                ;;
        esac
    done

    if [ -z "$name" ]; then
        print_error "Container name is required"
        echo "Usage: remo incus create <name> [options]"
        exit 1
    fi

    print_info "Creating Incus container '$name'..."

    # Build ansible extra vars
    extra_args+=(-e "container_name=$name")

    [ -n "$domain" ] && extra_args+=(-e "container_domain=$domain")
    [ -n "$image" ] && extra_args+=(-e "container_image=$image")

    if [ "$host" != "localhost" ]; then
        extra_args+=(-i "$host,")
        extra_args+=(-e "target_hosts=all")
        [ -n "$user" ] && extra_args+=(-e "incus_host_user=$user")
    fi

    run_playbook incus_site.yml "${extra_args[@]}"
}

incus_destroy() {
    local name=""
    local auto_confirm="false"
    local host="localhost"
    local user=""
    local extra_args=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --yes|-y)
                auto_confirm="true"
                shift
                ;;
            --host)
                host="$2"
                shift 2
                ;;
            --user)
                user="$2"
                shift 2
                ;;
            -*)
                print_error "Unknown option: $1"
                echo "Run 'remo incus --help' for usage."
                exit 1
                ;;
            *)
                if [ -z "$name" ]; then
                    name="$1"
                else
                    print_error "Unexpected argument: $1"
                    exit 1
                fi
                shift
                ;;
        esac
    done

    if [ -z "$name" ]; then
        print_error "Container name is required"
        echo "Usage: remo incus destroy <name> [options]"
        exit 1
    fi

    print_info "Destroying Incus container '$name'..."

    extra_args+=(-e "container_name=$name")
    extra_args+=(-e "auto_confirm=$auto_confirm")

    if [ "$host" != "localhost" ]; then
        extra_args+=(-i "$host,")
        extra_args+=(-e "target_hosts=all")
        [ -n "$user" ] && extra_args+=(-e "incus_host_user=$user")
    fi

    run_playbook incus_teardown.yml "${extra_args[@]}"
}

incus_list() {
    local host="localhost"
    local user=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --host)
                host="$2"
                shift 2
                ;;
            --user)
                user="$2"
                shift 2
                ;;
            -*)
                print_error "Unknown option: $1"
                echo "Run 'remo incus --help' for usage."
                exit 1
                ;;
            *)
                print_error "Unexpected argument: $1"
                exit 1
                ;;
        esac
    done

    if [ "$host" = "localhost" ]; then
        incus list
    else
        local ssh_cmd="ssh"
        [ -n "$user" ] && ssh_cmd="ssh ${user}@${host}" || ssh_cmd="ssh ${host}"
        $ssh_cmd incus list
    fi
}

incus_bootstrap() {
    local host="localhost"
    local user=""
    local verbose=""
    local extra_args=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --host)
                host="$2"
                shift 2
                ;;
            --user)
                user="$2"
                shift 2
                ;;
            -v|--verbose)
                verbose="detailed"
                shift
                ;;
            -*)
                print_error "Unknown option: $1"
                echo "Run 'remo incus --help' for usage."
                exit 1
                ;;
            *)
                print_error "Unexpected argument: $1"
                exit 1
                ;;
        esac
    done

    print_info "Bootstrapping Incus host..."

    if [ "$host" != "localhost" ]; then
        extra_args+=(-i "$host,")
        extra_args+=(-e "target_hosts=all")
        [ -n "$user" ] && extra_args+=(-e "ansible_user=$user")
    fi

    [ -n "$verbose" ] && extra_args+=(-e "incus_bootstrap_verbosity=$verbose")

    run_playbook incus_bootstrap.yml "${extra_args[@]}"
}

incus_update() {
    local name=""
    local host="localhost"
    local user=""
    local only=()
    local skip=()
    local extra_args=()

    # Available tools for --only and --skip
    local all_tools="docker user_setup nodejs devcontainers github_cli fzf zellij"

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --host)
                host="$2"
                shift 2
                ;;
            --user)
                user="$2"
                shift 2
                ;;
            --only)
                only+=("$2")
                shift 2
                ;;
            --skip)
                skip+=("$2")
                shift 2
                ;;
            -*)
                print_error "Unknown option: $1"
                echo "Run 'remo incus --help' for usage."
                exit 1
                ;;
            *)
                if [ -z "$name" ]; then
                    name="$1"
                else
                    print_error "Unexpected argument: $1"
                    exit 1
                fi
                shift
                ;;
        esac
    done

    if [ -z "$name" ]; then
        print_error "Container name is required"
        echo "Usage: remo incus update <name> [options]"
        exit 1
    fi

    # Get container IP from Incus host
    print_info "Looking up container '$name'..."
    local container_ip
    if [ "$host" = "localhost" ]; then
        container_ip=$(incus list "$name" -f csv -c 4 2>/dev/null | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' | head -1)
    else
        local ssh_target="$host"
        [ -n "$user" ] && ssh_target="${user}@${host}"
        container_ip=$(ssh "$ssh_target" "incus list '$name' -f csv -c 4" 2>/dev/null | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' | head -1)
    fi

    if [ -z "$container_ip" ]; then
        print_error "Could not find IP for container '$name'"
        exit 1
    fi

    print_info "Found container at $container_ip"
    print_info "Configuring container '$name'..."

    extra_args+=(-e "container_ip=$container_ip")

    # Handle --only: disable all tools except specified ones
    if [ ${#only[@]} -gt 0 ]; then
        for tool in $all_tools; do
            local enabled="false"
            for o in "${only[@]}"; do
                if [ "$tool" = "$o" ]; then
                    enabled="true"
                    break
                fi
            done
            extra_args+=(-e "configure_${tool}=$enabled")
        done
    fi

    # Handle --skip: disable specified tools
    if [ ${#skip[@]} -gt 0 ]; then
        for s in "${skip[@]}"; do
            extra_args+=(-e "configure_${s}=false")
        done
    fi

    run_playbook incus_configure.yml "${extra_args[@]}"
}

handle_incus() {
    local command="${1:-}"
    shift || true

    case "$command" in
        create)
            incus_create "$@"
            ;;
        destroy)
            incus_destroy "$@"
            ;;
        update)
            incus_update "$@"
            ;;
        list)
            incus_list "$@"
            ;;
        bootstrap)
            incus_bootstrap "$@"
            ;;
        --help|-h|"")
            show_incus_help
            ;;
        *)
            print_error "Unknown incus command: $command"
            echo "Run 'remo incus --help' for available commands."
            exit 1
            ;;
    esac
}

# =============================================================================
# HETZNER COMMANDS
# =============================================================================

hetzner_create() {
    local name=""
    local server_type=""
    local location=""
    local extra_args=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --name)
                name="$2"
                shift 2
                ;;
            --type)
                server_type="$2"
                shift 2
                ;;
            --location)
                location="$2"
                shift 2
                ;;
            -*)
                print_error "Unknown option: $1"
                echo "Run 'remo hetzner --help' for usage."
                exit 1
                ;;
            *)
                print_error "Unexpected argument: $1"
                exit 1
                ;;
        esac
    done

    print_info "Creating Hetzner VM..."

    [ -n "$name" ] && extra_args+=(-e "hetzner_server_name=$name")
    [ -n "$server_type" ] && extra_args+=(-e "hetzner_server_type=$server_type")
    [ -n "$location" ] && extra_args+=(-e "hetzner_location=$location")

    run_playbook hetzner_site.yml "${extra_args[@]}"
}

hetzner_destroy() {
    local auto_confirm="false"
    local remove_volume="false"
    local extra_args=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --yes|-y)
                auto_confirm="true"
                shift
                ;;
            --remove-volume)
                remove_volume="true"
                shift
                ;;
            -*)
                print_error "Unknown option: $1"
                echo "Run 'remo hetzner --help' for usage."
                exit 1
                ;;
            *)
                print_error "Unexpected argument: $1"
                exit 1
                ;;
        esac
    done

    if [ "$remove_volume" = "true" ]; then
        print_warning "WARNING: --remove-volume will destroy all data on the persistent volume!"
    fi

    print_info "Destroying Hetzner VM..."

    extra_args+=(-e "auto_confirm=$auto_confirm")
    extra_args+=(-e "remove_volume=$remove_volume")

    run_playbook hetzner_teardown.yml "${extra_args[@]}"
}

handle_hetzner() {
    local command="${1:-}"
    shift || true

    case "$command" in
        create)
            hetzner_create "$@"
            ;;
        destroy)
            hetzner_destroy "$@"
            ;;
        --help|-h|"")
            show_hetzner_help
            ;;
        *)
            print_error "Unknown hetzner command: $command"
            echo "Run 'remo hetzner --help' for available commands."
            exit 1
            ;;
    esac
}

# =============================================================================
# MAIN ENTRY POINT
# =============================================================================

main() {
    # Load environment variables
    load_env

    local provider="${1:-}"
    shift || true

    case "$provider" in
        init)
            handle_init "$@"
            ;;
        incus)
            handle_incus "$@"
            ;;
        hetzner)
            handle_hetzner "$@"
            ;;
        --help|-h|"")
            show_main_help
            ;;
        --version|-v)
            echo "remo 0.1.0"
            ;;
        *)
            print_error "Unknown command: $provider"
            echo "Run 'remo --help' for available commands."
            exit 1
            ;;
    esac
}

main "$@"
