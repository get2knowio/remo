---
# Shared dev tools configuration
# Include this from any playbook to install the standard dev environment
#
# Required: Run on a host with become: true and apt cache updated
#
# Optional variables to disable specific tools:
#   configure_docker: false
#   configure_user_setup: false
#   configure_nodejs: false
#   configure_devcontainers: false
#   configure_github_cli: false
#   configure_fzf: false
#   configure_zellij: false

- name: Install base utilities
  ansible.builtin.apt:
    name:
      - rsync
    state: present

- name: Set system timezone
  community.general.timezone:
    name: "{{ timezone }}"
  when: timezone | default('') | length > 0

- name: Allow TZ environment variable via SSH
  ansible.builtin.copy:
    dest: /etc/ssh/sshd_config.d/accept-tz.conf
    content: |
      # Allow clients to propagate their timezone
      AcceptEnv TZ
    mode: '0644'
  register: sshd_tz_config

- name: Restart sshd to apply AcceptEnv TZ
  ansible.builtin.service:
    name: "{{ 'ssh' if ansible_os_family == 'Debian' else 'sshd' }}"
    state: restarted
  when: sshd_tz_config.changed | default(false)

- name: Install Docker
  ansible.builtin.include_role:
    name: docker
  when: configure_docker | default(true) | bool

- name: Configure user environment
  ansible.builtin.include_role:
    name: user_setup
  vars:
    remo_version: "{{ lookup('pipe', 'git -C ' + playbook_dir + '/.. describe --tags --exact-match 2>/dev/null || echo \"\"') | regex_replace('^v', '') }}"
  when: configure_user_setup | default(true) | bool

- name: Install Node.js
  ansible.builtin.include_role:
    name: nodejs
  when: configure_nodejs | default(true) | bool

- name: Install Dev Containers CLI
  ansible.builtin.include_role:
    name: devcontainers
  when: configure_devcontainers | default(true) | bool

- name: Install GitHub CLI
  ansible.builtin.include_role:
    name: github_cli
  when: configure_github_cli | default(true) | bool

- name: Configure fzf
  ansible.builtin.include_role:
    name: fzf
  when: configure_fzf | default(true) | bool

- name: Install Zellij
  ansible.builtin.include_role:
    name: zellij
  when: configure_zellij | default(true) | bool
