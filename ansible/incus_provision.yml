---
# Incus Provision Playbook - Create a new container
# Usage: ./run.sh incus_provision.yml -e container_name=<name>
#        ./run.sh incus_provision.yml -i "incus-host," -e "container_name=<name> ansible_user=<user>"
#
# Required variables:
#   container_name: Name for the new container
#
# Optional variables (see roles/incus_container/defaults/main.yml):
#   container_image: Image to use (default: images:ubuntu/24.04/cloud)
#   container_profile: Incus profile to apply (default: default)
#   container_network: Network to attach container to (default: incusbr0)
#   container_ssh_user: SSH user (default: ubuntu)
#   container_ssh_key_path: Path to SSH public key (default: ~/.ssh/id_rsa.pub)
#   container_domain: Domain for FQDN (e.g., int.get2know.io)
#   container_mounts: List of host directory mounts
#
# Remote host support:
#   Use -i "hostname," to target a remote Incus host (note the trailing comma)
#   Use -e ansible_user=<user> to specify the SSH user for the Incus host

- name: Provision Incus container
  hosts: "{{ target_hosts | default('localhost') }}"
  connection: "{{ 'local' if (target_hosts | default('localhost')) == 'localhost' else 'ssh' }}"
  gather_facts: true

  vars:
    # Map user-friendly variable names to role variables
    incus_container_name: "{{ container_name }}"
    incus_container_image: "{{ container_image | default('images:ubuntu/24.04/cloud') }}"
    incus_container_profile: "{{ container_profile | default('default') }}"
    incus_container_network: "{{ container_network | default('incusbr0') }}"
    incus_container_ssh_user: "{{ container_ssh_user | default('ubuntu') }}"
    incus_container_ssh_key_path: "{{ container_ssh_key_path | default('~/.ssh/id_rsa.pub') }}"
    incus_container_domain: "{{ container_domain | default('') }}"
    incus_container_mounts: "{{ container_mounts | default([]) }}"

  pre_tasks:
    - name: Validate required variables
      ansible.builtin.fail:
        msg: "Required variable 'container_name' is not defined. Use -e container_name=<name>"
      when: container_name is not defined

  roles:
    - role: incus_container

  post_tasks:
    - name: Display container provisioning result
      ansible.builtin.debug:
        msg: |
          ============================================================
          Container '{{ incus_container_name }}' provisioned successfully!
          ============================================================

          IP Address: {{ incus_container_ip | default('N/A') }}
          Hostname: {{ incus_container_name }}{% if incus_container_domain | default('') | length > 0 %}.{{ incus_container_domain }}{% endif %}

          SSH User: {{ incus_container_ssh_user }}

          Primary access method (from your workstation):
          {% if incus_container_domain | default('') | length > 0 %}
            ssh {{ incus_container_ssh_user }}@{{ incus_container_name }}
            ssh {{ incus_container_ssh_user }}@{{ incus_container_name }}.{{ incus_container_domain }}
          {% endif %}
            ssh {{ incus_container_ssh_user }}@{{ incus_container_ip | default('<ip>') }}

          Alternative (from Incus host only):
            incus exec {{ incus_container_name }} -- bash

          Note: Macvlan containers are not directly reachable from the Incus host itself.
          {% if incus_container_domain | default('') | length > 0 %}
          Hostname DNS registration may take a few seconds to propagate.
          {% endif %}
          ============================================================
      when: incus_container_ip is defined
