---
# Incus Configure Playbook - Install dev tools on an existing container
# Run this after incus_provision.yml has created the container
#
# Usage:
#   ./run.sh incus_configure.yml -e "container_ip=<ip>"
#   ./run.sh incus_configure.yml -e "container_ip=<ip> container_user=remo"
#
# Required variables:
#   container_ip: IP address of the container to configure
#
# Optional variables:
#   container_user: SSH user (default: remo)
#   configure_docker: Enable/disable docker (default: true)
#   configure_user_setup: Enable/disable user_setup (default: true)
#   configure_nodejs: Enable/disable nodejs (default: true)
#   configure_devcontainers: Enable/disable devcontainers (default: true)
#   configure_github_cli: Enable/disable github_cli (default: true)
#   configure_fzf: Enable/disable fzf (default: true)
#   configure_zellij: Enable/disable zellij (default: true)

- name: Add container to inventory
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Validate required variables
      ansible.builtin.fail:
        msg: "Required variable 'container_ip' is not defined. Use -e container_ip=<ip>"
      when: container_ip is not defined

    - name: Add container to in-memory inventory
      ansible.builtin.add_host:
        name: incus_container
        ansible_host: "{{ container_ip }}"
        ansible_user: "{{ container_user | default('remo') }}"
        ansible_python_interpreter: /usr/bin/python3
        groups:
          - incus_containers

- name: Configure Incus container with development tools
  hosts: incus_container
  become: true
  gather_facts: true

  pre_tasks:
    - name: Wait for apt to be ready
      ansible.builtin.shell: |
        while fuser /var/lib/dpkg/lock-frontend /var/lib/apt/lists/lock /var/cache/apt/archives/lock >/dev/null 2>&1; do
          sleep 5
        done
      args:
        executable: /bin/bash
      register: apt_lock_result
      changed_when: false
      retries: 30
      delay: 10
      until: apt_lock_result.rc | default(1) == 0

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Upgrade all packages
      ansible.builtin.apt:
        upgrade: dist
        autoremove: true

  tasks:
    - name: Configure dev tools
      ansible.builtin.include_tasks: tasks/configure_dev_tools.yml

  post_tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          Container configuration complete!

          Installed:
          - Docker (with docker-compose plugin)
          - User 'remo' with sudo NOPASSWD access
          - User 'remo' added to docker group
          - Node.js LTS (v{{ nodejs_version }})
          - Git
          - fzf (fuzzy finder for TUI menu)
          - @devcontainers/cli
          - GitHub CLI (gh)
          - Zellij terminal multiplexer

          Login Experience:
          - Project menu auto-starts on SSH login
          - Select projects with arrow keys
          - Devcontainer projects auto-start their container
          - Non-devcontainer projects use zellij sessions

          Connect with:
            ssh remo@{{ ansible_host }}
