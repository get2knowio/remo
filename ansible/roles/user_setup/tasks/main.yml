---
- name: Create g2k user
  ansible.builtin.user:
    name: "{{ g2k_user }}"
    shell: /bin/bash
    create_home: true
    state: present

- name: Add g2k user to docker group
  ansible.builtin.user:
    name: "{{ g2k_user }}"
    groups: docker
    append: true

- name: Configure passwordless sudo for g2k user
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/{{ g2k_user }}
    line: "{{ g2k_user }} ALL=(ALL) NOPASSWD:ALL"
    create: true
    mode: '0440'
    validate: 'visudo -cf %s'

- name: Create devcontainer mount directories
  ansible.builtin.file:
    path: "/home/{{ g2k_user }}/{{ item }}"
    state: directory
    owner: "{{ g2k_user }}"
    group: "{{ g2k_user }}"
    mode: '0755'
  loop:
    - .codex
    - .config/opencode
    - .config/gh
    - .coderabbit
    - .local/bin
    - bin

- name: Create development workspace directory
  ansible.builtin.file:
    path: "{{ dev_workspace_dir }}"
    state: directory
    owner: "{{ g2k_user }}"
    group: "{{ g2k_user }}"
    mode: '0755'

- name: Ensure ~/bin is in PATH via .bashrc
  ansible.builtin.blockinfile:
    path: "/home/{{ g2k_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - PATH"
    block: |
      # Add ~/bin to PATH if it exists
      if [ -d "$HOME/bin" ] ; then
          PATH="$HOME/bin:$PATH"
      fi
    create: true
    owner: "{{ g2k_user }}"
    group: "{{ g2k_user }}"
    mode: '0644'

- name: Configure zellij auto-start on SSH login
  ansible.builtin.blockinfile:
    path: "/home/{{ g2k_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - ZELLIJ"
    block: |
      # Auto-start zellij on SSH login
      # Only trigger when:
      #   - Shell is interactive
      #   - Session is SSH (SSH_TTY or SSH_CONNECTION is set)
      #   - Not already inside a zellij session
      if [[ $- == *i* ]] && [[ -n "$SSH_TTY" || -n "$SSH_CONNECTION" ]] && [[ -z "$ZELLIJ" ]]; then
          zellij attach --create {{ zellij_session_name }}
          exit
      fi
    create: true
    owner: "{{ g2k_user }}"
    group: "{{ g2k_user }}"
    mode: '0644'
    insertafter: EOF

- name: Install devshell helper script
  ansible.builtin.template:
    src: devshell.sh.j2
    dest: "/home/{{ g2k_user }}/bin/devshell"
    owner: "{{ g2k_user }}"
    group: "{{ g2k_user }}"
    mode: '0755'

- name: Verify g2k user exists
  ansible.builtin.command: id {{ g2k_user }}
  register: user_setup_user_info
  changed_when: false

- name: Display user information
  ansible.builtin.debug:
    msg: "User created: {{ user_setup_user_info.stdout }}"
