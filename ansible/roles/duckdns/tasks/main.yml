---
# Preflight validation
- name: Validate DuckDNS token is set
  ansible.builtin.fail:
    msg: |
      DuckDNS token is not configured.
      Set the DUCKDNS_TOKEN environment variable or pass -e duckdns_token=<token>
  when: duckdns_token | default('') | length == 0

- name: Validate DuckDNS domain is set
  ansible.builtin.fail:
    msg: |
      DuckDNS domain is not configured.
      Set the DUCKDNS_DOMAIN environment variable or pass -e duckdns_domain=<domain>
  when: duckdns_domain | default('') | length == 0

- name: Update DuckDNS with server IP
  delegate_to: localhost
  become: false
  ansible.builtin.uri:
    url: "https://www.duckdns.org/update?domains={{ duckdns_domain }}&token={{ duckdns_token }}&ip={{ hetzner_server_ip }}"
    method: GET
    return_content: true
  register: duckdns_response

- name: Verify DuckDNS update was successful
  ansible.builtin.assert:
    that:
      - "'OK' in duckdns_response.content"
    fail_msg: "DuckDNS update failed: {{ duckdns_response.content }}"
    success_msg: "DuckDNS domain {{ duckdns_domain }}.duckdns.org updated to {{ hetzner_server_ip }}"

- name: Display DuckDNS information
  ansible.builtin.debug:
    msg: "DuckDNS domain: {{ duckdns_domain }}.duckdns.org -> {{ hetzner_server_ip }}"
