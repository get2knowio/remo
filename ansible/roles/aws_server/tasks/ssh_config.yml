---
# SSH Config - Manage ~/.ssh/config entry for easy SSH access

- name: Determine hostname for SSH config
  ansible.builtin.set_fact:
    aws_ssh_hostname: "{{ aws_full_dns_name | default(aws_instance_public_dns) | default(aws_elastic_ip) | default(aws_instance_public_ip) }}"

- name: Ensure SSH config directory exists
  delegate_to: localhost
  become: false
  ansible.builtin.file:
    path: "{{ aws_ssh_config_path | expanduser | dirname }}"
    state: directory
    mode: '0700'

- name: Ensure SSH config file exists
  delegate_to: localhost
  become: false
  ansible.builtin.file:
    path: "{{ aws_ssh_config_path | expanduser }}"
    state: touch
    mode: '0600'
  changed_when: false

- name: Update SSH config with remo-aws entry
  delegate_to: localhost
  become: false
  ansible.builtin.blockinfile:
    path: "{{ aws_ssh_config_path | expanduser }}"
    marker: "# {mark} remo:aws:{{ aws_resource_name }}"
    block: |
      Host {{ aws_ssh_host_alias }}
          HostName {{ aws_ssh_hostname }}
          User remo
          IdentityFile {{ aws_ssh_private_key_path | expanduser }}
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
    create: true
    mode: '0600'

- name: Display SSH config info
  ansible.builtin.debug:
    msg: |
      SSH config updated. You can now connect using:
        ssh {{ aws_ssh_host_alias }}
