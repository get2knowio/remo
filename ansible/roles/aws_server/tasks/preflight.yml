---
# Preflight checks - validate credentials and auto-detect current IP
# Supports both explicit credentials (env vars) and AWS SSO

- name: Check if boto3 Python library is available
  delegate_to: localhost
  become: false
  ansible.builtin.command:
    cmd: "{{ ansible_playbook_python }} -c 'import boto3'"
  register: boto3_check
  changed_when: false
  failed_when: false

- name: Ensure boto3 Python library is installed
  delegate_to: localhost
  become: false
  ansible.builtin.pip:
    name:
      - boto3
      - botocore
    state: present
    executable: "{{ ansible_playbook_python | dirname }}/pip"
  when: boto3_check.rc | default(1) != 0

- name: Validate SSH public key exists
  delegate_to: localhost
  become: false
  ansible.builtin.stat:
    path: "{{ aws_ssh_public_key_path | expanduser }}"
  register: ssh_key_stat

- name: Fail if SSH public key does not exist
  ansible.builtin.fail:
    msg: |
      SSH public key not found at: {{ aws_ssh_public_key_path }}
      Please specify a valid path with -e aws_ssh_public_key_path=<path>
  when: not (ssh_key_stat.stat.exists | default(false))

- name: Verify AWS credentials work
  delegate_to: localhost
  become: false
  ansible.builtin.shell:
    cmd: |
      {{ ansible_playbook_python }} << 'PYTHON'
      import boto3
      # Use default credential chain (picks up env vars set by playbook)
      session = boto3.Session()
      sts = session.client('sts')
      identity = sts.get_caller_identity()
      print(identity['Account'] + ':' + identity['Arn'])
      PYTHON
  register: caller_identity_result
  changed_when: false

- name: Set caller identity result
  ansible.builtin.set_fact:
    caller_identity_output: "{{ caller_identity_result.stdout | default('') }}"

- name: Display AWS account info
  ansible.builtin.debug:
    msg: "AWS Account: {{ caller_identity_output.split(':')[0] }} ({{ caller_identity_output.split(':')[1:] | join(':') }})"
