---
# Preflight checks - validate credentials and auto-detect current IP
# Supports both explicit credentials (env vars) and AWS SSO

- name: Check if boto3 Python library is available
  delegate_to: localhost
  become: false
  ansible.builtin.command:
    cmd: "{{ ansible_playbook_python }} -c 'import boto3'"
  register: boto3_check
  changed_when: false
  failed_when: false

- name: Ensure boto3 Python library is installed
  delegate_to: localhost
  become: false
  ansible.builtin.pip:
    name:
      - boto3
      - botocore
    state: present
    executable: "{{ ansible_playbook_python | dirname }}/pip"
  when: boto3_check.rc | default(1) != 0

- name: Determine AWS authentication method
  ansible.builtin.set_fact:
    aws_use_profile: "{{ aws_profile | default('') | length > 0 }}"
    aws_use_explicit_creds: "{{ (aws_access_key_id | default('') | length > 0) and (aws_secret_access_key | default('') | length > 0) and (aws_profile | default('') | length == 0) }}"

- name: Auto-detect current public IP if not specified
  delegate_to: localhost
  become: false
  ansible.builtin.uri:
    url: "https://checkip.amazonaws.com"
    return_content: true
  register: current_ip_result
  when: aws_allowed_ssh_cidr | default('') | length == 0

- name: Set SSH allowed CIDR from detected IP
  ansible.builtin.set_fact:
    aws_allowed_ssh_cidr: "{{ current_ip_result.content | trim }}/32"
  when: aws_allowed_ssh_cidr | default('') | length == 0

- name: Display detected IP
  ansible.builtin.debug:
    msg: "SSH will be allowed from: {{ aws_allowed_ssh_cidr }}"

- name: Validate SSH public key exists
  delegate_to: localhost
  become: false
  ansible.builtin.stat:
    path: "{{ aws_ssh_public_key_path | expanduser }}"
  register: ssh_key_stat

- name: Fail if SSH public key does not exist
  ansible.builtin.fail:
    msg: |
      SSH public key not found at: {{ aws_ssh_public_key_path }}
      Please specify a valid path with -e aws_ssh_public_key_path=<path>
  when: not (ssh_key_stat.stat.exists | default(false))

- name: Verify AWS credentials work
  delegate_to: localhost
  become: false
  ansible.builtin.shell:
    cmd: |
      {{ ansible_playbook_python }} << 'PYTHON'
      import boto3
      {% if aws_profile %}
      # Use SSO profile
      session = boto3.Session(profile_name='{{ aws_profile }}', region_name='{{ aws_region }}')
      {% elif aws_access_key_id and aws_secret_access_key %}
      # Use explicit credentials
      session = boto3.Session(
        aws_access_key_id='{{ aws_access_key_id }}',
        aws_secret_access_key='{{ aws_secret_access_key }}',
        region_name='{{ aws_region }}')
      {% else %}
      # Use default credential chain (env vars, IAM role, etc.)
      session = boto3.Session(region_name='{{ aws_region }}')
      {% endif %}
      sts = session.client('sts')
      identity = sts.get_caller_identity()
      print(identity['Account'] + ':' + identity['Arn'])
      PYTHON
  register: caller_identity_result
  changed_when: false

- name: Set caller identity result
  ansible.builtin.set_fact:
    caller_identity_output: "{{ caller_identity_result.stdout | default('') }}"

- name: Display AWS account info
  ansible.builtin.debug:
    msg: "AWS Account: {{ caller_identity_output.split(':')[0] }} ({{ caller_identity_output.split(':')[1:] | join(':') }})"
