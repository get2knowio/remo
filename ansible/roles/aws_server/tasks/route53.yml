---
# Route53 DNS record (optional)

- name: Validate Route53 configuration
  ansible.builtin.fail:
    msg: |
      Route53 DNS was requested but configuration is incomplete.
      Set the following environment variables:
        AWS_ROUTE53_ZONE_ID
        AWS_ROUTE53_ZONE_DOMAIN
      Or pass them via -e aws_route53_zone_id=<id> -e aws_route53_zone_domain=<domain>
  when: >
    (aws_route53_zone_id | default('') | length == 0) or
    (aws_route53_zone_domain | default('') | length == 0)

- name: Set DNS record name
  ansible.builtin.set_fact:
    aws_full_dns_name: "{{ aws_route53_record_name }}.{{ aws_route53_zone_domain }}"

- name: Display Route53 info
  ansible.builtin.debug:
    msg: "Creating DNS record: {{ aws_full_dns_name }} -> {{ aws_elastic_ip | default(aws_instance_public_ip) }}"

- name: Create Route53 A record
  delegate_to: localhost
  become: false
  amazon.aws.route53:
    profile: "{{ aws_profile if aws_profile else omit }}"
    access_key: "{{ omit if aws_profile else (aws_access_key_id if aws_access_key_id else omit) }}"
    secret_key: "{{ omit if aws_profile else (aws_secret_access_key if aws_secret_access_key else omit) }}"
    state: present
    zone: "{{ aws_route53_zone_domain }}"
    record: "{{ aws_full_dns_name }}"
    type: A
    ttl: 300
    value:
      - "{{ aws_elastic_ip | default(aws_instance_public_ip) }}"
    overwrite: true
  register: route53_result

- name: Display DNS record info
  ansible.builtin.debug:
    msg: "DNS record created: {{ aws_full_dns_name }}"

- name: Wait for DNS propagation
  delegate_to: localhost
  become: false
  ansible.builtin.command:
    cmd: "nslookup {{ aws_full_dns_name }} 8.8.8.8"
  register: dns_check
  changed_when: false
  failed_when: false
  retries: 12
  delay: 10
  until: dns_check.rc == 0
