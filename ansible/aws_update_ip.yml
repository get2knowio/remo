---
# AWS Update IP Playbook - Updates security group with current public IP
# Usage: remo aws update-ip

- name: Update AWS Security Group with Current IP
  hosts: localhost
  gather_facts: false
  vars:
    # Resource naming
    aws_resource_name: "{{ lookup('env', 'USER') | default('remo', true) }}"
    aws_security_group_name: "remo-{{ aws_resource_name }}-sg"

    # AWS credentials
    aws_access_key_id: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
    aws_secret_access_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
    aws_region: "{{ lookup('env', 'AWS_REGION') | default('us-west-2', true) }}"

  tasks:
    - name: Validate AWS credentials are set
      ansible.builtin.fail:
        msg: |
          AWS credentials are not configured.
          Set the following environment variables:
            AWS_ACCESS_KEY_ID
            AWS_SECRET_ACCESS_KEY
      when: >
        (aws_access_key_id | default('') | length == 0) or
        (aws_secret_access_key | default('') | length == 0)

    - name: Auto-detect current public IP
      ansible.builtin.uri:
        url: "https://checkip.amazonaws.com"
        return_content: true
      register: current_ip_result

    - name: Set SSH allowed CIDR from detected IP
      ansible.builtin.set_fact:
        aws_allowed_ssh_cidr: "{{ current_ip_result.content | trim }}/32"

    - name: Display detected IP
      ansible.builtin.debug:
        msg: "Current public IP: {{ current_ip_result.content | trim }}"

    - name: Get default VPC info
      amazon.aws.ec2_vpc_net_info:
        access_key: "{{ aws_access_key_id }}"
        secret_key: "{{ aws_secret_access_key }}"
        region: "{{ aws_region }}"
        filters:
          isDefault: "true"
      register: default_vpc_result

    - name: Fail if no default VPC exists
      ansible.builtin.fail:
        msg: "No default VPC found in region {{ aws_region }}"
      when: default_vpc_result.vpcs | default([]) | length == 0

    - name: Update security group with new IP
      amazon.aws.ec2_security_group:
        name: "{{ aws_security_group_name }}"
        description: "SSH access for remo dev environment ({{ aws_resource_name }})"
        vpc_id: "{{ default_vpc_result.vpcs[0].vpc_id }}"
        region: "{{ aws_region }}"
        access_key: "{{ aws_access_key_id }}"
        secret_key: "{{ aws_secret_access_key }}"
        rules:
          - proto: tcp
            ports:
              - 22
            cidr_ip: "{{ aws_allowed_ssh_cidr }}"
            rule_desc: "SSH from {{ aws_allowed_ssh_cidr }}"
        rules_egress:
          - proto: all
            cidr_ip: "0.0.0.0/0"
            rule_desc: "Allow all outbound"
        purge_rules: true
        state: present
        tags:
          Name: "{{ aws_security_group_name }}"
          remo: "true"
          remo_resource_name: "{{ aws_resource_name }}"
      register: sg_update_result

    - name: Display update result
      ansible.builtin.debug:
        msg: |
          Security group '{{ aws_security_group_name }}' updated successfully!

          SSH is now allowed from: {{ aws_allowed_ssh_cidr }}

          You can now connect using:
            ssh remo-aws
