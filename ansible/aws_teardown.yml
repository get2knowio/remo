---
# AWS Teardown Playbook - Destroys AWS resources
# Usage:
#   ./run.sh aws_teardown.yml                           # Destroy instance only (keep storage)
#   ./run.sh aws_teardown.yml -e remove_storage=true    # Destroy instance AND storage (EBS/EFS)

- name: Tear down AWS Resources
  hosts: localhost
  gather_facts: false
  become: false
  vars:
    # Use remo venv Python which has boto3 installed
    ansible_python_interpreter: "{{ lookup('env', 'HOME') }}/.remo/.venv/bin/python"
    # By default, keep storage to preserve data
    remove_storage: false
    remove_efs: "{{ remove_storage }}"  # Backward compatibility
    auto_confirm: false

    # Resource naming
    aws_resource_name: "{{ lookup('env', 'USER') | default('remo', true) }}"
    aws_key_name: "remo-{{ aws_resource_name }}-key"
    aws_security_group_name: "remo-{{ aws_resource_name }}-sg"
    aws_ebs_name: "remo-{{ aws_resource_name }}-home"
    aws_efs_name: "remo-{{ aws_resource_name }}-home"
    aws_instance_name: "remo-{{ aws_resource_name }}"

    # AWS credentials
    aws_profile: "{{ lookup('env', 'AWS_PROFILE') | default('', true) }}"
    aws_access_key_id: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') | default('', true) }}"
    aws_secret_access_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') | default('', true) }}"
    aws_region: "{{ lookup('env', 'AWS_REGION') | default('us-west-2', true) }}"

  environment:
    AWS_PROFILE: "{{ aws_profile | default('') }}"
    AWS_ACCESS_KEY_ID: "{{ '' if aws_profile else (aws_access_key_id | default('')) }}"
    AWS_SECRET_ACCESS_KEY: "{{ '' if aws_profile else (aws_secret_access_key | default('')) }}"
    AWS_DEFAULT_REGION: "{{ aws_region | default('us-west-2') }}"

  tasks:

    - name: Display teardown warning
      ansible.builtin.debug:
        msg: |
          WARNING: This will destroy the following resources:
          - EC2 Instance: {{ aws_instance_name }}
          - Elastic IP: {{ aws_instance_name }}-eip
          - Security Group: {{ aws_security_group_name }}
          - Key Pair: {{ aws_key_name }}
          {% if remove_storage | bool %}
          - EBS Volume: {{ aws_ebs_name }} (ALL DATA WILL BE LOST!)
          - EFS (if exists): {{ aws_efs_name }} (ALL DATA WILL BE LOST!)
          {% else %}
          - Storage (EBS/EFS) will be PRESERVED
          {% endif %}

    - name: Confirm teardown
      ansible.builtin.pause:
        prompt: "Are you sure you want to proceed? (yes/no)"
      register: confirm_teardown
      when: not (auto_confirm | default(false) | bool)

    - name: Abort if not confirmed
      ansible.builtin.fail:
        msg: "Teardown aborted by user"
      when:
        - not (auto_confirm | default(false) | bool)
        - confirm_teardown.user_input | default('') | lower != 'yes'

    # Get instance info first
    - name: Get EC2 instance info
      amazon.aws.ec2_instance_info:
        region: "{{ aws_region }}"
        filters:
          "tag:Name": "{{ aws_instance_name }}"
          "tag:remo": "true"
          instance-state-name:
            - pending
            - running
            - stopping
            - stopped
      register: existing_instance

    # Release Elastic IP first (must be done before instance termination for cleaner cleanup)
    - name: Get Elastic IP info
      amazon.aws.ec2_eip_info:
        region: "{{ aws_region }}"
        filters:
          "tag:Name": "{{ aws_instance_name }}-eip"
          "tag:remo": "true"
      register: existing_eip

    - name: Release Elastic IP
      amazon.aws.ec2_eip:
        region: "{{ aws_region }}"
        public_ip: "{{ existing_eip.addresses[0].public_ip }}"
        state: absent
      when: existing_eip.addresses | default([]) | length > 0
      register: eip_delete_result

    - name: Display Elastic IP release result
      ansible.builtin.debug:
        msg: "Elastic IP released successfully"
      when: eip_delete_result is changed | default(false)

    # Terminate EC2 instance
    - name: Terminate EC2 instance
      amazon.aws.ec2_instance:
        region: "{{ aws_region }}"
        instance_ids:
          - "{{ existing_instance.instances[0].instance_id }}"
        state: terminated
        wait: true
        wait_timeout: 300
      when: existing_instance.instances | default([]) | length > 0
      register: instance_delete_result

    - name: Display instance termination result
      ansible.builtin.debug:
        msg: "EC2 instance '{{ aws_instance_name }}' terminated successfully"
      when: instance_delete_result is changed | default(false)

    - name: Display instance not found message
      ansible.builtin.debug:
        msg: "EC2 instance '{{ aws_instance_name }}' was not found (already terminated or never created)"
      when: existing_instance.instances | default([]) | length == 0

    # Delete EBS volume if requested
    - name: Get EBS volume info
      amazon.aws.ec2_vol_info:
        region: "{{ aws_region }}"
        filters:
          "tag:Name": "{{ aws_ebs_name }}"
          "tag:remo": "true"
      register: existing_ebs
      when: remove_storage | bool

    - name: Wait for EBS volume to detach
      amazon.aws.ec2_vol_info:
        region: "{{ aws_region }}"
        filters:
          volume-id: "{{ existing_ebs.volumes[0].id }}"
      register: ebs_detach_status
      until: (ebs_detach_status.volumes[0].attachments | default([]) | length == 0) or (ebs_detach_status.volumes[0].status == 'available')
      retries: 30
      delay: 10
      when:
        - remove_storage | bool
        - existing_ebs.volumes | default([]) | length > 0

    - name: Delete EBS volume
      amazon.aws.ec2_vol:
        id: "{{ existing_ebs.volumes[0].id }}"
        region: "{{ aws_region }}"
        state: absent
      when:
        - remove_storage | bool
        - existing_ebs.volumes | default([]) | length > 0
      register: ebs_delete_result

    - name: Display EBS deletion result
      ansible.builtin.debug:
        msg: "EBS volume '{{ aws_ebs_name }}' deleted successfully - ALL DATA HAS BEEN REMOVED"
      when:
        - remove_storage | bool
        - ebs_delete_result is changed | default(false)

    # Delete EFS if requested (legacy or if using EFS storage type)
    - name: Get EFS info
      community.aws.efs_info:
        region: "{{ aws_region }}"
        tags:
          Name: "{{ aws_efs_name }}"
      register: existing_efs
      when: remove_efs | bool

    - name: Delete EFS mount targets first
      community.aws.efs:
        region: "{{ aws_region }}"
        id: "{{ existing_efs.efs[0].file_system_id }}"
        state: absent
        wait: true
        wait_timeout: 300
      when:
        - remove_efs | bool
        - existing_efs.efs | default([]) | length > 0
      register: efs_delete_result

    - name: Display EFS deletion result
      ansible.builtin.debug:
        msg: "EFS '{{ aws_efs_name }}' deleted successfully - ALL DATA HAS BEEN REMOVED"
      when:
        - remove_efs | bool
        - efs_delete_result is changed | default(false)

    # Delete EFS security group (always try - it references main SG so must be deleted first)
    - name: Delete EFS security group
      amazon.aws.ec2_security_group:
        name: "{{ aws_efs_name }}-sg"
        region: "{{ aws_region }}"
        state: absent
      register: efs_sg_delete_result
      failed_when: false

    # Delete security group (may need to wait for instance to fully terminate)
    - name: Wait for instance to fully terminate
      ansible.builtin.pause:
        seconds: 30
      when: instance_delete_result is changed | default(false)

    - name: Delete security group
      amazon.aws.ec2_security_group:
        name: "{{ aws_security_group_name }}"
        region: "{{ aws_region }}"
        state: absent
      register: sg_delete_result
      retries: 5
      delay: 10
      until: sg_delete_result is not failed

    - name: Display security group deletion result
      ansible.builtin.debug:
        msg: "Security group '{{ aws_security_group_name }}' deleted successfully"
      when: sg_delete_result is changed | default(false)

    # Delete key pair
    - name: Delete EC2 key pair
      amazon.aws.ec2_key:
        name: "{{ aws_key_name }}"
        region: "{{ aws_region }}"
        state: absent
      register: key_delete_result

    - name: Display key pair deletion result
      ansible.builtin.debug:
        msg: "Key pair '{{ aws_key_name }}' deleted successfully"
      when: key_delete_result is changed | default(false)

    - name: Display storage preserved message
      ansible.builtin.debug:
        msg: |
          Storage has been PRESERVED.
          Your data in /home/remo will be available when you provision a new instance.
          To remove all storage and data, run:
            remo aws destroy --remove-storage
      when: not (remove_storage | bool)

    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          Teardown complete!

          Deleted resources:
          - EC2 Instance: {{ aws_instance_name }}
          - Elastic IP: {{ aws_instance_name }}-eip
          - Security Group: {{ aws_security_group_name }}
          - Key Pair: {{ aws_key_name }}
          {% if remove_storage | bool %}
          - EBS Volume: {{ aws_ebs_name }} (if existed)
          - EFS: {{ aws_efs_name }} (if existed)
          {% endif %}

          {% if not remove_storage | bool %}
          Preserved resources:
          - EBS Volume / EFS: {{ aws_ebs_name }}

          To reprovision the instance with the same storage:
            remo aws create
          {% else %}
          All resources have been removed. To start fresh:
            remo aws create
          {% endif %}
