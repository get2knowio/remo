---
# AWS Teardown Playbook - Destroys AWS resources
# Usage:
#   ./run.sh aws_teardown.yml                        # Destroy instance only (keep EFS)
#   ./run.sh aws_teardown.yml -e remove_efs=true     # Destroy instance AND EFS

- name: Tear down AWS Resources
  hosts: localhost
  gather_facts: false
  vars:
    # By default, keep EFS to preserve data
    remove_efs: false
    auto_confirm: false

    # Resource naming
    aws_resource_name: "{{ lookup('env', 'USER') | default('remo', true) }}"
    aws_key_name: "remo-{{ aws_resource_name }}-key"
    aws_security_group_name: "remo-{{ aws_resource_name }}-sg"
    aws_efs_name: "remo-{{ aws_resource_name }}-home"
    aws_instance_name: "remo-{{ aws_resource_name }}"

    # AWS credentials - supports SSO via AWS_PROFILE or explicit credentials
    aws_profile: "{{ lookup('env', 'AWS_PROFILE') | default('', true) }}"
    aws_access_key_id: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') | default('', true) }}"
    aws_secret_access_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') | default('', true) }}"
    aws_region: "{{ lookup('env', 'AWS_REGION') | default('us-west-2', true) }}"

  tasks:

    - name: Display teardown warning
      ansible.builtin.debug:
        msg: |
          WARNING: This will destroy the following resources:
          - EC2 Instance: {{ aws_instance_name }}
          - Elastic IP: {{ aws_instance_name }}-eip
          - Security Group: {{ aws_security_group_name }}
          - Key Pair: {{ aws_key_name }}
          {% if remove_efs | bool %}
          - EFS: {{ aws_efs_name }} (ALL DATA WILL BE LOST!)
          {% else %}
          - EFS: {{ aws_efs_name }} (will be PRESERVED)
          {% endif %}

    - name: Confirm teardown
      ansible.builtin.pause:
        prompt: "Are you sure you want to proceed? (yes/no)"
      register: confirm_teardown
      when: not (auto_confirm | default(false) | bool)

    - name: Abort if not confirmed
      ansible.builtin.fail:
        msg: "Teardown aborted by user"
      when:
        - not (auto_confirm | default(false) | bool)
        - confirm_teardown.user_input | default('') | lower != 'yes'

    # Get instance info first
    - name: Get EC2 instance info
      amazon.aws.ec2_instance_info:
        profile: "{{ aws_profile if aws_profile else omit }}"
        access_key: "{{ aws_access_key_id if (aws_access_key_id and not aws_profile) else omit }}"
        secret_key: "{{ aws_secret_access_key if (aws_secret_access_key and not aws_profile) else omit }}"
        region: "{{ aws_region }}"
        filters:
          "tag:Name": "{{ aws_instance_name }}"
          "tag:remo": "true"
          instance-state-name:
            - pending
            - running
            - stopping
            - stopped
      register: existing_instance

    # Release Elastic IP first (must be done before instance termination for cleaner cleanup)
    - name: Get Elastic IP info
      amazon.aws.ec2_eip_info:
        profile: "{{ aws_profile if aws_profile else omit }}"
        access_key: "{{ aws_access_key_id if (aws_access_key_id and not aws_profile) else omit }}"
        secret_key: "{{ aws_secret_access_key if (aws_secret_access_key and not aws_profile) else omit }}"
        region: "{{ aws_region }}"
        filters:
          "tag:Name": "{{ aws_instance_name }}-eip"
          "tag:remo": "true"
      register: existing_eip

    - name: Release Elastic IP
      amazon.aws.ec2_eip:
        profile: "{{ aws_profile if aws_profile else omit }}"
        access_key: "{{ aws_access_key_id if (aws_access_key_id and not aws_profile) else omit }}"
        secret_key: "{{ aws_secret_access_key if (aws_secret_access_key and not aws_profile) else omit }}"
        region: "{{ aws_region }}"
        public_ip: "{{ existing_eip.addresses[0].public_ip }}"
        state: absent
      when: existing_eip.addresses | default([]) | length > 0
      register: eip_delete_result

    - name: Display Elastic IP release result
      ansible.builtin.debug:
        msg: "Elastic IP released successfully"
      when: eip_delete_result is changed | default(false)

    # Terminate EC2 instance
    - name: Terminate EC2 instance
      amazon.aws.ec2_instance:
        profile: "{{ aws_profile if aws_profile else omit }}"
        access_key: "{{ aws_access_key_id if (aws_access_key_id and not aws_profile) else omit }}"
        secret_key: "{{ aws_secret_access_key if (aws_secret_access_key and not aws_profile) else omit }}"
        region: "{{ aws_region }}"
        instance_ids:
          - "{{ existing_instance.instances[0].instance_id }}"
        state: terminated
        wait: true
        wait_timeout: 300
      when: existing_instance.instances | default([]) | length > 0
      register: instance_delete_result

    - name: Display instance termination result
      ansible.builtin.debug:
        msg: "EC2 instance '{{ aws_instance_name }}' terminated successfully"
      when: instance_delete_result is changed | default(false)

    - name: Display instance not found message
      ansible.builtin.debug:
        msg: "EC2 instance '{{ aws_instance_name }}' was not found (already terminated or never created)"
      when: existing_instance.instances | default([]) | length == 0

    # Delete EFS if requested
    - name: Get EFS info
      amazon.aws.efs_info:
        profile: "{{ aws_profile if aws_profile else omit }}"
        access_key: "{{ aws_access_key_id if (aws_access_key_id and not aws_profile) else omit }}"
        secret_key: "{{ aws_secret_access_key if (aws_secret_access_key and not aws_profile) else omit }}"
        region: "{{ aws_region }}"
        tags:
          Name: "{{ aws_efs_name }}"
      register: existing_efs
      when: remove_efs | bool

    - name: Delete EFS mount targets first
      community.aws.efs:
        profile: "{{ aws_profile if aws_profile else omit }}"
        access_key: "{{ aws_access_key_id if (aws_access_key_id and not aws_profile) else omit }}"
        secret_key: "{{ aws_secret_access_key if (aws_secret_access_key and not aws_profile) else omit }}"
        region: "{{ aws_region }}"
        id: "{{ existing_efs.efs[0].file_system_id }}"
        state: absent
        wait: true
        wait_timeout: 300
      when:
        - remove_efs | bool
        - existing_efs.efs | default([]) | length > 0
      register: efs_delete_result

    - name: Display EFS deletion result
      ansible.builtin.debug:
        msg: "EFS '{{ aws_efs_name }}' deleted successfully - ALL DATA HAS BEEN REMOVED"
      when:
        - remove_efs | bool
        - efs_delete_result is changed | default(false)

    # Delete EFS security group
    - name: Delete EFS security group
      amazon.aws.ec2_security_group:
        name: "{{ aws_efs_name }}-sg"
        region: "{{ aws_region }}"
        profile: "{{ aws_profile if aws_profile else omit }}"
        access_key: "{{ aws_access_key_id if (aws_access_key_id and not aws_profile) else omit }}"
        secret_key: "{{ aws_secret_access_key if (aws_secret_access_key and not aws_profile) else omit }}"
        state: absent
      register: efs_sg_delete_result
      when: remove_efs | bool

    # Delete security group (may need to wait for instance to fully terminate)
    - name: Wait for instance to fully terminate
      ansible.builtin.pause:
        seconds: 30
      when: instance_delete_result is changed | default(false)

    - name: Delete security group
      amazon.aws.ec2_security_group:
        name: "{{ aws_security_group_name }}"
        region: "{{ aws_region }}"
        profile: "{{ aws_profile if aws_profile else omit }}"
        access_key: "{{ aws_access_key_id if (aws_access_key_id and not aws_profile) else omit }}"
        secret_key: "{{ aws_secret_access_key if (aws_secret_access_key and not aws_profile) else omit }}"
        state: absent
      register: sg_delete_result
      retries: 5
      delay: 10
      until: sg_delete_result is not failed

    - name: Display security group deletion result
      ansible.builtin.debug:
        msg: "Security group '{{ aws_security_group_name }}' deleted successfully"
      when: sg_delete_result is changed | default(false)

    # Delete key pair
    - name: Delete EC2 key pair
      amazon.aws.ec2_key:
        name: "{{ aws_key_name }}"
        region: "{{ aws_region }}"
        profile: "{{ aws_profile if aws_profile else omit }}"
        access_key: "{{ aws_access_key_id if (aws_access_key_id and not aws_profile) else omit }}"
        secret_key: "{{ aws_secret_access_key if (aws_secret_access_key and not aws_profile) else omit }}"
        state: absent
      register: key_delete_result

    - name: Display key pair deletion result
      ansible.builtin.debug:
        msg: "Key pair '{{ aws_key_name }}' deleted successfully"
      when: key_delete_result is changed | default(false)

    - name: Display EFS preserved message
      ansible.builtin.debug:
        msg: |
          EFS '{{ aws_efs_name }}' has been PRESERVED.
          Your data in /home/remo will be available when you provision a new instance.
          To remove the EFS and all data, run:
            remo aws destroy --remove-efs
      when: not (remove_efs | bool)

    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          Teardown complete!

          Deleted resources:
          - EC2 Instance: {{ aws_instance_name }}
          - Elastic IP: {{ aws_instance_name }}-eip
          - Security Group: {{ aws_security_group_name }}
          - Key Pair: {{ aws_key_name }}
          {% if remove_efs | bool %}
          - EFS: {{ aws_efs_name }}
          {% endif %}

          {% if not remove_efs | bool %}
          Preserved resources:
          - EFS: {{ aws_efs_name }}

          To reprovision the instance with the same EFS:
            remo aws create
          {% else %}
          All resources have been removed. To start fresh:
            remo aws create
          {% endif %}
