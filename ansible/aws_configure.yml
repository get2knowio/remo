---
# AWS Configure Playbook - Install/update dev tools on an existing instance
# Run this to update an already provisioned AWS EC2 instance
#
# Usage:
#   ./run.sh aws_configure.yml -e "instance_ip=<ip>"
#   ./run.sh aws_configure.yml -e "instance_ip=<ip> instance_user=ubuntu"
#
# Required variables:
#   instance_ip: IP address of the instance to configure
#
# Optional variables:
#   instance_user: SSH user (default: ubuntu for initial, remo after setup)
#   configure_docker: Enable/disable docker (default: true)
#   configure_user_setup: Enable/disable user_setup (default: true)
#   configure_nodejs: Enable/disable nodejs (default: true)
#   configure_devcontainers: Enable/disable devcontainers (default: true)
#   configure_github_cli: Enable/disable github_cli (default: true)
#   configure_fzf: Enable/disable fzf (default: true)
#   configure_zellij: Enable/disable zellij (default: true)

- name: Add instance to inventory
  hosts: localhost
  gather_facts: false
  vars:
    aws_region_effective: "{{ aws_region | default(lookup('env', 'AWS_REGION') | default(lookup('env', 'AWS_DEFAULT_REGION') | default('us-west-2', true), true), true) }}"

  tasks:
    - name: Validate required variables
      ansible.builtin.fail:
        msg: "Required variable 'instance_ip' is not defined. Use -e instance_ip=<ip>"
      when: instance_ip is not defined

    - name: Add instance to in-memory inventory (direct)
      ansible.builtin.add_host:
        name: aws_instance
        ansible_host: "{{ instance_ip }}"
        ansible_user: "{{ instance_user | default('remo') }}"
        ansible_ssh_private_key_file: "{{ ssh_private_key_path | default('~/.ssh/id_rsa') }}"
        groups:
          - provisioned
      when: (aws_access_mode | default('direct')) != 'ssm'

    - name: Add instance to in-memory inventory (SSM)
      ansible.builtin.add_host:
        name: aws_instance
        ansible_host: "{{ aws_instance_id }}"
        ansible_user: "{{ instance_user | default('remo') }}"
        ansible_ssh_private_key_file: "{{ ssh_private_key_path | default('~/.ssh/id_rsa') }}"
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ProxyCommand="aws ssm start-session --region {{ aws_region_effective }} --target %h --document-name AWS-StartSSHSession --parameters portNumber=%p"'
        groups:
          - provisioned
      when: (aws_access_mode | default('direct')) == 'ssm'

- name: Configure AWS EC2 instance with development tools
  hosts: aws_instance
  become: true
  gather_facts: true

  pre_tasks:
    - name: Wait for apt to be ready
      ansible.builtin.shell: |
        while fuser /var/lib/dpkg/lock-frontend /var/lib/apt/lists/lock /var/cache/apt/archives/lock >/dev/null 2>&1; do
          sleep 5
        done
      args:
        executable: /bin/bash
      register: apt_lock_result
      changed_when: false
      retries: 30
      delay: 10
      until: apt_lock_result.rc == 0

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Upgrade all packages
      ansible.builtin.apt:
        upgrade: dist
        autoremove: true

    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required_file

  tasks:
    - name: Configure dev tools
      ansible.builtin.include_tasks: tasks/configure_dev_tools.yml

  post_tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          Instance configuration complete!

          Installed:
          - Docker (with docker-compose plugin)
          - User 'remo' with sudo NOPASSWD access
          - User 'remo' added to docker group
          - Node.js LTS (v{{ nodejs_version }})
          - Git
          - fzf (fuzzy finder for TUI menu)
          - @devcontainers/cli
          - GitHub CLI (gh)
          - Zellij terminal multiplexer

          Login Experience:
          - Project menu auto-starts on SSH login
          - Select projects with arrow keys
          - Devcontainer projects auto-start their container
          - Non-devcontainer projects use zellij sessions

          Connect with:
            ssh remo@{{ ansible_host }}

    - name: Reboot instance if required by package updates
      ansible.builtin.reboot:
        msg: "Rebooting to apply system updates"
        reboot_timeout: 300
      when: reboot_required_file.stat.exists | default(false)

    - name: Display reboot status
      ansible.builtin.debug:
        msg: "{{ 'Instance was rebooted to apply system updates.' if reboot_required_file.stat.exists | default(false) else 'No reboot was required.' }}"
